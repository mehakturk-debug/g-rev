<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TaskFlow Pro v15 - Ultimate</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --muted: #94a3b8; --danger: #ef4444; --wa: #25d366; --success: #10b981;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 15px; }
        
        header { text-align: center; padding: 20px 0; background: rgba(30, 41, 59, 0.5); }
        .main-logo { max-width: 120px; height: auto; margin-bottom: 5px; }
        
        /* Navigation */
        .main-nav { display: flex; justify-content: center; gap: 8px; background: var(--card); padding: 10px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #334155; }
        .nav-btn { padding: 10px 18px; border-radius: 8px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: white; }

        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 18px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .stat-card h2 { margin: 8px 0 0; font-size: 2rem; color: var(--primary); }
        .stat-card p { margin: 0; color: var(--muted); font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }

        /* Alarm Overlay & Activator */
        #alarm-activator { background: var(--danger); color: white; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 12px; }
        #alarm-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(239, 68, 68, 0.95); z-index: 9999; 
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .stop-btn { background: white; color: var(--danger); padding: 18px 40px; border-radius: 50px; font-size: 1.4rem; font-weight: bold; border: none; cursor: pointer; margin-top: 20px; }

        /* Cards & Forms */
        .glass-card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        h3 { margin: 0 0 15px 0; font-size: 1rem; color: var(--primary); border-bottom: 1px solid #334155; padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        
        input, select, button { width: 100%; padding: 12px; background: #334155; border: 1px solid #475569; color: white; border-radius: 10px; font-size: 14px; outline: none; box-sizing: border-box; }
        
        /* Task Cards */
        .task-card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid var(--primary); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .prio-Acil { border-left-color: var(--danger); }
        .completed-card { border-left-color: var(--success); opacity: 0.8; }
        .meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px; color: var(--muted); margin-top: 10px; }

        .page { display: none; }
        .page.active { display: block; }
        
        #status-indicator { font-size: 10px; text-align: center; color: var(--muted); padding-bottom: 5px; }
    </style>
</head>
<body>

<audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto" loop></audio>
<div id="alarm-overlay">
    <i class="fas fa-exclamation-triangle fa-4x" style="margin-bottom: 20px; color: white;"></i>
    <h1 style="color: white; margin: 0;">GÃ–REV VAKTÄ°!</h1>
    <p id="alarm-desc" style="font-size: 1.2rem; color: white; margin: 15px 0 30px; padding: 0 20px;"></p>
    <button class="stop-btn" onclick="app.stopAlarm()">ALARM SUSTUR</button>
</div>

<header>
    <img src="gÃ¶rev.png" alt="Logo" class="main-logo" onerror="this.style.display='none'">
    <div id="status-indicator">VeritabanÄ± kontrol ediliyor...</div>
</header>
<div id="alarm-activator" onclick="app.unlockAudio()"><i class="fas fa-bell"></i> SESLÄ° ALARMLARI AKTÄ°FLEÅžTÄ°RMEK Ä°Ã‡Ä°N DOKUNUN</div>

<nav class="main-nav">
    <button class="nav-btn active" onclick="app.showPage('dashboard')"><i class="fas fa-chart-pie"></i> Panel</button>
    <button class="nav-btn" onclick="app.showPage('tasks')"><i class="fas fa-list-check"></i> GÃ¶revler</button>
    <button class="nav-btn" onclick="app.showPage('management')"><i class="fas fa-user-gear"></i> YÃ¶netim</button>
</nav>

<div class="container">
    
    <div id="page-dashboard" class="page active">
        <div class="stats-grid">
            <div class="stat-card"><p>BugÃ¼n</p><h2 id="s_today">0</h2></div>
            <div class="stat-card"><p>Bu Hafta</p><h2 id="s_week">0</h2></div>
            <div class="stat-card"><p>Bu Ay</p><h2 id="s_month">0</h2></div>
            <div class="stat-card"><p>ArÅŸiv</p><h2 id="s_archive">0</h2></div>
        </div>
        <div class="glass-card">
            <h3><i class="fas fa-users"></i> Personel YÃ¼k DaÄŸÄ±lÄ±mÄ±</h3>
            <div id="personStats" style="font-size: 14px; color: var(--muted);">Veri yÃ¼kleniyor...</div>
        </div>
    </div>

    <div id="page-tasks" class="page">
        <div class="glass-card">
            <h3><i class="fas fa-plus"></i> GÃ¶rev Atama</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                <select id="selCat"></select>
                <select id="selPerson"></select>
                <select id="selPrio"><option>Normal</option><option>Acil</option></select>
                <input type="datetime-local" id="jobEnd">
                <input type="text" id="jobDesc" placeholder="GÃ¶rev detayÄ±..." style="grid-column: span 1;">
                <button onclick="app.addTask()" style="background:var(--primary)">Kaydet ve Bildir</button>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; display: flex; gap: 8px;">
            <button onclick="app.setFilter('active')" id="btn-active" class="nav-btn active" style="background: #1e293b; border: 1px solid var(--primary);">Aktif Ä°ÅŸler</button>
            <button onclick="app.setFilter('archive')" id="btn-archive" class="nav-btn" style="background: #1e293b; border: 1px solid var(--muted);">ArÅŸiv</button>
        </div>
        <div id="taskList"></div>
    </div>

    <div id="page-management" class="page">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <div class="glass-card">
                <h3><i class="fas fa-tags"></i> Kategori YÃ¶netimi</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="newCat"><button onclick="app.addCat()" style="width:50px">+</button></div>
                <ul id="catAdminList" style="list-style:none; padding:0;"></ul>
            </div>
            <div class="glass-card">
                <h3><i class="fas fa-users-cog"></i> Personel YÃ¶netimi</h3>
                <input type="text" id="newName" placeholder="Ad Soyad" style="margin-bottom:5px">
                <input type="tel" id="newPhone" placeholder="905XXXXXXXXX" style="margin-bottom:10px">
                <button onclick="app.addPerson()" style="background:var(--success)">Yeni Personel Kaydet</button>
                <ul id="personAdminList" style="list-style:none; padding:10px 0;"></ul>
            </div>
        </div>
    </div>

</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBUF3LdVqpHkC5Ha2YReluEY5cbe9ScKhg",
    authDomain: "is-takip-sistemi-94c21.firebaseapp.com",
    projectId: "is-takip-sistemi-94c21",
    storageBucket: "is-takip-sistemi-94c21.firebasestorage.app",
    messagingSenderId: "113312619940",
    appId: "1:113312619940:web:59e4daaec3d9e8800a3531",
    databaseURL: "https://is-takip-sistemi-94c21-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const app = {
    tasks: {}, filter: 'active', audioUnlocked: false, notified: new Set(), currentTaskId: null,

    init() {
        db.ref(".info/connected").on("value", s => {
            const el = document.getElementById('status-indicator');
            el.innerText = s.val() ? "â— SÄ°STEM BAÄžLI" : "â—‹ BAÄžLANTI YOK";
            el.style.color = s.val() ? "#25d366" : "#ef4444";
        });
        db.ref('categories').on('value', s => this.upCat(s.val() || {}));
        db.ref('people').on('value', s => this.upPers(s.val() || {}));
        db.ref('tasks').on('value', s => { this.tasks = s.val() || {}; this.render(); this.runStats(); });
        
        setInterval(() => this.checkAlarms(), 20000);
    },

    unlockAudio() {
        document.getElementById('alarmSound').play().then(() => {
            document.getElementById('alarmSound').pause();
            this.audioUnlocked = true;
            const btn = document.getElementById('alarm-activator');
            btn.innerText = "âœ… ALARMLAR AKTÄ°F";
            btn.style.background = "#10b981";
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{});
        });
    },

    checkAlarms() {
        if (!this.audioUnlocked) return;
        const now = new Date();
        Object.keys(this.tasks).forEach(k => {
            const t = this.tasks[k];
            if (t.status === 'active') {
                const tDate = new Date(t.end);
                if (tDate <= now && (now - tDate) < 600000 && !this.notified.has(k)) {
                    this.triggerAlarm(t.desc, k);
                }
            }
        });
    },

    triggerAlarm(desc, id) {
        this.currentTaskId = id;
        document.getElementById('alarm-desc').innerText = desc;
        document.getElementById('alarm-overlay').style.display = 'flex';
        document.getElementById('alarmSound').play();
        if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
    },

    stopAlarm() {
        document.getElementById('alarmSound').pause();
        document.getElementById('alarmSound').currentTime = 0;
        document.getElementById('alarm-overlay').style.display = 'none';
        if (this.currentTaskId) this.notified.add(this.currentTaskId);
    },

    showPage(p) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.main-nav .nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    },

    setFilter(f) {
        this.filter = f;
        document.getElementById('btn-active').classList.toggle('active', f === 'active');
        document.getElementById('btn-archive').classList.toggle('active', f === 'archive');
        this.render();
    },

    upCat(data) {
        const el = document.getElementById('catAdminList'); const sel = document.getElementById('selCat');
        el.innerHTML = ''; sel.innerHTML = '';
        Object.keys(data).forEach(k => {
            el.innerHTML += `<li style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #334155;">${data[k]} <i class="fas fa-trash" onclick="app.del('categories/${k}')" style="color:var(--danger); cursor:pointer"></i></li>`;
            sel.innerHTML += `<option>${data[k]}</option>`;
        });
    },

    upPers(data) {
        const el = document.getElementById('personAdminList'); const sel = document.getElementById('selPerson');
        el.innerHTML = ''; sel.innerHTML = '';
        Object.keys(data).forEach(k => {
            el.innerHTML += `<li style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #334155;">${data[k].name} <i class="fas fa-user-minus" onclick="app.del('people/${k}')" style="color:var(--danger); cursor:pointer"></i></li>`;
            sel.innerHTML += `<option value="${k}">${data[k].name}</option>`;
        });
    },

    addCat() { const v = document.getElementById('newCat').value.trim(); if(v) db.ref('categories').push(v).then(()=>document.getElementById('newCat').value=''); },
    addPerson() {
        const n = document.getElementById('newName').value.trim(); const p = document.getElementById('newPhone').value.trim();
        if(n && p) db.ref('people').push({name:n, phone:p}).then(()=>{ document.getElementById('newName').value=''; document.getElementById('newPhone').value=''; });
    },

    addTask() {
        const pk = document.getElementById('selPerson').value;
        if(!pk) return alert("Personel seÃ§in!");
        db.ref('people/'+pk).once('value', s => {
            const task = {
                desc: document.getElementById('jobDesc').value, cat: document.getElementById('selCat').value,
                prio: document.getElementById('selPrio').value, end: document.getElementById('jobEnd').value,
                uName: s.val().name, uPhone: s.val().phone, status: 'active', doneAt: ''
            };
            if(!task.desc || !task.end) return alert("Eksik alan!");
            db.ref('tasks').push(task).then(() => {
                window.open(`https://wa.me/${task.uPhone}?text=ðŸš€ *YENÄ° GÃ–REV ATAMASI*%0A%0A*Ä°ÅŸ:* ${task.desc}%0A*BitiÅŸ:* ${task.end.replace('T',' ')}`, '_blank');
                document.getElementById('jobDesc').value = '';
            });
        });
    },

    complete(id) { db.ref('tasks/'+id).update({status:'archive', doneAt: new Date().toLocaleString('tr-TR')}); },
    del(p) { if(confirm("Emin misiniz?")) db.ref(p).remove(); },

    runStats() {
        const now = new Date(); let s = { today:0, week:0, month:0, archive:0, users:{} };
        Object.values(this.tasks).forEach(t => {
            if(t.status === 'archive') s.archive++;
            else {
                const d = new Date(t.end);
                if(d.toDateString() === now.toDateString()) s.today++;
                if((d-now) < 604800000) s.week++;
                if((d-now) < 2592000000) s.month++;
                s.users[t.uName] = (s.users[t.uName] || 0) + 1;
            }
        });
        document.getElementById('s_today').innerText = s.today; document.getElementById('s_week').innerText = s.week;
        document.getElementById('s_month').innerText = s.month; document.getElementById('s_archive').innerText = s.archive;
        let uHtml = ''; for(let u in s.users) uHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; background:rgba(255,255,255,0.03); padding:8px; border-radius:8px;"><span>${u}</span><b style="color:var(--primary)">${s.users[u]} Aktif Ä°ÅŸ</b></div>`;
        document.getElementById('personStats').innerHTML = uHtml || "Aktif iÅŸ bulunmuyor.";
    },

    render() {
        const container = document.getElementById('taskList'); container.innerHTML = '';
        Object.keys(this.tasks).reverse().forEach(k => {
            const t = this.tasks[k];
            if(t.status !== this.filter) return;
            container.innerHTML += `
                <div class="task-card prio-${t.prio} ${t.status === 'archive' ? 'completed-card' : ''}">
                    <div style="display:flex; justify-content:space-between">
                        <b>${t.desc}</b>
                        <i class="fas fa-trash" onclick="app.del('tasks/${k}')" style="color:var(--danger); cursor:pointer"></i>
                    </div>
                    <div class="meta">
                        <span><i class="fas fa-folder"></i> ${t.cat}</span>
                        <span><i class="fas fa-user"></i> ${t.uName}</span>
                        <span><i class="fas fa-calendar"></i> ${t.status==='active' ? t.end.replace('T',' ') : 'Bitti: '+t.doneAt}</span>
                    </div>
                    ${t.status === 'active' ? `<button onclick="app.complete('${k}')" style="margin-top:12px; background:var(--success); border:none; padding:8px; font-weight:bold;">TAMAMLA</button>` : ''}
                </div>`;
        });
    }
};
app.init();
</script>
</body>
</html>
